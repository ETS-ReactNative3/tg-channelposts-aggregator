version: '3.7'

services:
  drone-server:
    image: drone/drone:1.2.1
    container_name: drone-server
    ports:
      - 8088:80/tcp
    volumes:
      - drone-server-sqlite:/var/lib/drone/
    logging:
      driver: json-file
      options:
        max-size: '5m'
        max-file: '3'
    depends_on:
      - traefik
    env_file:
      - ./.env.drone.server
    networks:
      - drone
      - drone_ci
    deploy:
      # To use an external load balancer without the routing mesh:
      # https://docs.docker.com/engine/swarm/ingress/#without-the-routing-mesh
      endpoint_mode: dnsrr # drone-server:8088
      labels:
        - 'traefik.enable=true'
        - 'traefik.http.routers.drone.rule=Host(`${DRONE_SERVER_HOST}`)'
        - 'traefik.http.routers.drone.entrypoints=drone_entry'
        - 'traefik.http.services.drone-server.loadbalancer.server.port=${DRONE_SERVER_PORT}'
        - 'traefik.docker.network=drone'
        # - 'traefik.http.routers.drone.tls.certresolver=leresolver'
      placement:
        constraints:
          - node.role != manager
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 5s
        failure_action: pause
        order: start-first
        monitor: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  drone-agent:
    image: drone/agent:1.2.1
    container_name: drone-agent
    command: agent
    logging:
      driver: json-file
      options:
        max-size: '5m'
        max-file: '3'
    depends_on:
      - drone-server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - drone-agent:/data
    env_file:
      - ./.env.drone.agent
    networks:
      - drone_ci
    deploy:
      placement:
        constraints:
          - node.role != manager
        preferences:
          - spread: node.labels.drone_ci
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 5s
        failure_action: pause
        order: start-first
        monitor: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

volumes:
  drone-server-sqlite: {}
  drone-agent: {}

networks:
  drone:
    driver: overlay
    external: true
    attachable: true
  drone_ci:
    driver: overlay
    external: true
    attachable: true
